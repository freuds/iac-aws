{
  "variables": {
    "role": null,
    "service": null,
    "playbook_file": null,
    "zone": "europe-west1-b",
    "source_image_family": "debian-10",
    "machine_type": "undefined",
    "ssh_user": "debian",
    "box_name" : "bento/debian-10.2",
    "box_version" : "202002.04.0",
    "box_folder": "undefined",
    "box_checksum": "undefined",
    "box_base_mac": "undefined",
    "vagrant_ssh_keys": "undefined"
  },
  "builders": [{
    "type": "googlecompute",
    "account_file": "{{ template_dir }}/../account_quotatis-legacy.json",
    "project_id": "quotatis-legacy",
    "source_image_family": "{{ user `source_image_family` }}",
    "image_family": "{{ user `service` }}-legacy",
    "machine_type": "{{ user `machine_type` }}",
    "disk_type": "pd-ssd",
    "zone": "{{ user `zone` }}",
    "ssh_username": "{{ user `ssh_user` }}",
    "image_name": "{{ user `service` }}-{{ user `role` }}-{{ user `source_image_family` }}-{{ timestamp }}"
  },
  {
    "type": "virtualbox-ovf",
    "communicator": "ssh",
    "source_path": "{{ user `box_folder` }}/box.ovf",
    "checksum": "{{ user `box_checksum` }}",
    "checksum_type": "sha256",
    "guest_additions_mode": "disable",
    "headless": true,
    "ssh_pty": true,
    "ssh_username": "vagrant",
    "ssh_port": "62222",
    "ssh_private_key_file": "{{ user `vagrant_ssh_private_key` }}",
    "ssh_skip_nat_mapping": true,
    "shutdown_command": "sudo shutdown -P now",
    "output_directory": "/tmp/packer_output",
    "target_path": "/tmp/packer_cache",
    "skip_export": true,
		"virtualbox_version_file": ".vbox_version",
    "vboxmanage": [
      [ "modifyvm", "{{ .Name }}", "--cpus", "2" ],
      [ "modifyvm", "{{ .Name }}", "--memory", "2048" ],
      [ "modifyvm", "{{ .Name }}", "--nic1", "nat" ],
      [ "modifyvm", "{{ .Name }}", "--natpf1", "packerssh,tcp,127.0.0.1,62222,,22" ],
      [ "modifyvm", "{{ .Name }}", "--uart1", "0x3F8", "4" ],
      [ "modifyvm", "{{ .Name }}", "--macaddress1", "{{ user `box_base_mac` }}" ]
    ]
  }],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sleep 20"
      ]
    },
    {
      "type": "shell",
      "scripts": [
        "{{ template_dir }}/../scripts/bootstrap.sh"
      ]
    },
    {
      "type": "ansible-local",
      "playbook_file": "{{ template_dir }}/{{ user `playbook_file` }}",
      "playbook_dir": "{{ template_dir }}/../../../ansible/",
      "inventory_groups": "{{ user `inventory_groups` }}",
      "command": "ANSIBLE_FORCE_COLOR=1 PYTHONUNBUFFERED=1 ansible-playbook",
      "extra_arguments": [ " --extra-vars \"SERVICE={{ user `service` }}\""]
    },
    {
      "type": "shell",
      "scripts": [
        "{{ template_dir }}/../scripts/cleanup.sh"
      ]
    }
  ]
}
